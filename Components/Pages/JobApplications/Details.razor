@page "/jobapplications/details/{id:int}"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using JobApplicationTrackerV2.Data
@using JobApplicationTrackerV2.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@attribute [Authorize]

@if (model == null)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudText Typo="Typo.h3" Class="mb-4">Detaljer - @model.Jobbtitel</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-2">Företagsinformation</MudText>
                <MudDivider Class="mb-3" />


                <MudStack Spacing="2">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                        <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Företag</MudText>
                            <MudText Typo="Typo.body1"><strong>@model.Foretag</strong></MudText>
                        </div>
                    </MudStack>

                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                        <MudIcon Icon="@Icons.Material.Filled.Work" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Jobbtitel</MudText>
                            <MudText Typo="Typo.body1">@model.Jobbtitel</MudText>
                        </div>
                    </MudStack>

                    @if (!string.IsNullOrEmpty(model.Plats))
                    {
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Plats</MudText>
                                <MudText Typo="Typo.body1">@model.Plats</MudText>
                            </div>
                        </MudStack>
                    }

                    @if (!string.IsNullOrEmpty(model.Url))
                    {
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                            <MudIcon Icon="@Icons.Material.Filled.Link" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Länk till annons</MudText>
                                <MudLink Href="@model.Url" Target="_blank" Typo="Typo.body1">
                                    Öppna annons <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" />
                                </MudLink>
                            </div>
                        </MudStack>
                    }
                </MudStack>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudText Typo="Typo.h6" Class="mb-2">Ansökningsinformation</MudText>
                <MudDivider Class="mb-3" />


                <MudStack Spacing="2">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Ansökningsdatum</MudText>
                            <MudText Typo="Typo.body1">@model.AnsokanDatum.ToLongDateString()</MudText>
                            <MudText Typo="Typo.caption">(@GetDaysAgo(model.AnsokanDatum))</MudText>
                        </div>
                    </MudStack>

                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                        <MudIcon Icon="@Icons.Material.Filled.Flag" Color="Color.Primary" />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                            @switch (model.Status)
                            {
                                case ApplicationStatus.VantarPaSvar:
                                    <MudChip T="string" Color="Color.Warning">Väntar på svar</MudChip>
                                    break;
                                case ApplicationStatus.Ja:
                                    <MudChip T="string" Color="Color.Success">Ja - Erbjudande mottaget!</MudChip>
                                    break;
                                case ApplicationStatus.Nej:
                                    <MudChip T="string" Color="Color.Error">Nej - Avslag</MudChip>
                                    break;
                                case ApplicationStatus.GattVideare:
                                    <MudChip T="string" Color="Color.Info">Gått vidare i processen</MudChip>
                                    break;
                                case ApplicationStatus.Intervju:
                                    <MudChip T="string" Color="Color.Primary">Intervju bokad</MudChip>
                                    break;
                                case ApplicationStatus.Avbruten:
                                    <MudChip T="string" Color="Color.Default">Avbruten</MudChip>
                                    break;
                            }
                        </div>
                    </MudStack>
                </MudStack>
            </MudItem>

            @if (!string.IsNullOrEmpty(model.Anteckningar))
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2 mt-4">Anteckningar</MudText>
                    <MudDivider Class="mb-3" />
                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                        <MudStack Row="true" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Notes" Color="Color.Secondary" />
                            <MudText Typo="Typo.body1" Style="white-space: pre-wrap;">@model.Anteckningar</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </MudPaper>

    <MudStack Row="true" Spacing="2" Class="mt-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit" Href="@($"/jobapplications/edit/{model.Id}")">
            Redigera
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Default" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/jobapplications">
            Tillbaka till listan
        </MudButton>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete" OnClick="DeleteApplication">
            Ta bort
        </MudButton>
    </MudStack>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private JobApplication? model;
    private string? userId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var appUser = await UserManager.GetUserAsync(user);
            userId = appUser?.Id;

            if (userId != null)
            {
                using var context = await DbContextFactory.CreateDbContextAsync();
                model = await context.JobApplications
                    .FirstOrDefaultAsync(j => j.Id == Id && j.UserId == userId);

                if (model == null)
                {
                    Snackbar.Add("Jobbansökan hittades inte eller du har inte behörighet att se den.", Severity.Warning);
                    NavigationManager.NavigateTo("/jobapplications");
                }
            }
        }
    }

    private string GetDaysAgo(DateTime date)
    {
        var days = (DateTime.Today - date.Date).Days;

        if (days == 0)
            return "Idag";
        else if (days == 1)
            return "Igår";
        else if (days < 7)
            return $"För {days} dagar sedan";
        else if (days < 14)
            return "För 1 vecka sedan";
        else if (days < 30)
            return $"För {days / 7} veckor sedan";
        else if (days < 60)
            return "För 1 månad sedan";
        else
            return $"För {days / 30} månader sedan";
    }

    private async Task DeleteApplication()
    {
        if (model == null || string.IsNullOrEmpty(userId))
            return;

        try
        {
            using var context = await DbContextFactory.CreateDbContextAsync();
            var application = await context.JobApplications.FindAsync(model.Id);

            if (application != null && application.UserId == userId)
            {
                context.JobApplications.Remove(application);
                await context.SaveChangesAsync();

                Snackbar.Add("Jobbansökan borttagen!", Severity.Success);
                NavigationManager.NavigateTo("/jobapplications");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fel vid borttagning: {ex.Message}", Severity.Error);
        }
    }
}
